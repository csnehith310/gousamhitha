<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deliveries - Gousamhitha Admin</title>
    <link rel="stylesheet" href="admin-styles.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="admin-page">
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2>Gousamhitha Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="admin-dashboard.html" class="nav-link">Dashboard</a>
                <a href="admin-products.html" class="nav-link">Products</a>
                <a href="admin-add-product.html" class="nav-link">Add Product</a>
                <a href="admin-vendors.html" class="nav-link">Vendors</a>
                <a href="admin-orders.html" class="nav-link">Orders</a>
                <a href="admin-deliveries.html" class="nav-link active">Deliveries</a>
                <a href="admin-payouts.html" class="nav-link">Vendor Payouts</a>
                <a href="#" class="nav-link" onclick="adminLogout()">Logout</a>
            </nav>
        </aside>
        
        <main class="admin-content">
            <div class="content-header">
                <h1>Delivery Management</h1>
            </div>
            
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody id="deliveries-table-body">
                        
                    </tbody>
                </table>
            </div>
        </main>
    </div>
    
    <script src="config.js"></script>
    <script src="supabase-auth.js"></script>
    <script src="admin-script.js"></script>
    <script src="js/toast.js"></script>
    <script>
        async function loadDeliveriesTable() {
            console.log('=== LOADING DELIVERIES TABLE ===');
            const tbody = document.getElementById('deliveries-table-body');
            if (!tbody) {
                console.error('deliveries-table-body element not found');
                return;
            }
            
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">Loading deliveries...</td></tr>';
            
            if (!window.supabase) {
                console.error('Supabase not initialized');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #d32f2f;">Database not connected. Please refresh the page.</td></tr>';
                return;
            }
            
            try {
                console.log('Fetching orders from Supabase...');
                const { data: orders, error } = await window.supabase
                    .from('orders')
                    .select('*, order_items(*)')
                    .order('created_at', { ascending: false });
                
                console.log('Fetched orders:', orders);
                
                if (error) {
                    console.error('Error fetching orders:', error);
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #d32f2f;">Error loading deliveries: ${error.message}</td></tr>`;
                    return;
                }
                
                if (!orders || orders.length === 0) {
                    console.log('No orders found');
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No deliveries yet</td></tr>';
                    return;
                }
                
                console.log(`Rendering ${orders.length} deliveries`);
                tbody.innerHTML = orders.map((order) => {
                    const items = order.order_items || [];
                    const itemsText = items.map(item => `${item.product_name} (${item.quantity})`).join(', ');
                    const shortId = order.id.substring(0, 8);
                    
                    const fullAddress = [
                        order.address,
                        order.city,
                        order.pincode
                    ].filter(part => part).join(', ');
                    
                    const locationBtn = (order.latitude && order.longitude) 
                        ? `<button class="action-btn btn-view" onclick="window.viewLocation(${order.latitude}, ${order.longitude})" style="background: #2196F3; color: white; padding: 0.4rem 0.8rem; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem;">📍 View Map</button>`
                        : '<span style="color: #999; font-size: 0.85rem;">No location</span>';
                    
                    const statusColor = {
                        'Pending': '#ff9800',
                        'Packed': '#2196F3',
                        'Shipped': '#9c27b0',
                        'Delivered': '#4caf50'
                    }[order.order_status] || '#666';
                    
                    return `
                    <tr>
                        <td style="font-family: monospace; font-size: 0.9rem;">${shortId}</td>
                        <td>
                            <div style="font-weight: 600;">${order.customer_name}</div>
                            <div style="font-size: 0.85rem; color: #666;">${order.email || 'N/A'}</div>
                        </td>
                        <td>${order.phone}</td>
                        <td style="max-width: 250px;">
                            <div style="font-size: 0.85rem; line-height: 1.4;">${fullAddress || 'No address'}</div>
                        </td>
                        <td style="max-width: 200px;">
                            <div style="font-size: 0.9rem;">${itemsText || 'No items'}</div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.3rem;">${items.length} item(s)</div>
                        </td>
                        <td style="font-weight: 600; color: #4a7c59;">₹${order.total}</td>
                        <td>
                            <select class="status-select" onchange="window.updateDeliveryStatus('${order.id}', this.value)" style="padding: 0.4rem; border-radius: 5px; border: 1px solid #ddd; background: ${statusColor}15; color: ${statusColor}; font-weight: 600;">
                                <option value="Pending" ${order.order_status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Packed" ${order.order_status === 'Packed' ? 'selected' : ''}>Packed</option>
                                <option value="Shipped" ${order.order_status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                                <option value="Delivered" ${order.order_status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                        </td>
                        <td>${locationBtn}</td>
                    </tr>
                `}).join('');
                console.log('Deliveries rendered successfully');
            } catch (error) {
                console.error('Exception in loadDeliveriesTable:', error);
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #d32f2f;">Error loading deliveries: ${error.message}</td></tr>`;
            }
        }

        async function updateDeliveryStatus(orderId, newStatus) {
            console.log('=== UPDATING DELIVERY STATUS ===');
            console.log('Order ID:', orderId);
            console.log('New Status:', newStatus);
            
            if (!window.supabase) {
                alert('Database connection error. Please refresh the page.');
                return;
            }
            
            try {
                const { error } = await window.supabase
                    .from('orders')
                    .update({ 
                        order_status: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', orderId);
                
                if (error) {
                    console.error('Error updating status:', error);
                    alert('Failed to update delivery status: ' + error.message);
                    return;
                }
                
                console.log('Delivery status updated successfully');
                
                if (typeof showToast === 'function') {
                    showToast(`Delivery status updated to ${newStatus}`, 'success');
                }
                
                await loadDeliveriesTable();
                
            } catch (error) {
                console.error('Exception in updateDeliveryStatus:', error);
                alert('Error: ' + (error.message || 'Failed to update status'));
            }
        }

        window.updateDeliveryStatus = updateDeliveryStatus;

        document.addEventListener('DOMContentLoaded', async function() {
            let retries = 0;
            while (typeof window.supabase === 'undefined' && retries < 20) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }
            
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase failed to initialize!');
                return;
            }
            
            console.log('Supabase initialized, loading deliveries...');
            await loadDeliveriesTable();
            
            const ordersChannel = window.supabase
                .channel('orders-changes')
                .on('postgres_changes', 
                    { event: 'UPDATE', schema: 'public', table: 'orders' },
                    (payload) => {
                        console.log('Order updated:', payload);
                        loadDeliveriesTable();
                    }
                )
                .subscribe();
        });
    </script>
</body>
</html>
