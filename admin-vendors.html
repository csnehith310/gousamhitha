<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vendors - Gousamhitha Admin</title>
    <link rel="stylesheet" href="admin-styles.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="admin-page">
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <h2>Gousamhitha Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="admin-dashboard.html" class="nav-link">Dashboard</a>
                <a href="admin-products.html" class="nav-link">Products</a>
                <a href="admin-add-product.html" class="nav-link">Add Product</a>
                <a href="admin-vendors.html" class="nav-link active">Vendors</a>
                <a href="admin-orders.html" class="nav-link">Orders</a>
                <a href="admin-payouts.html" class="nav-link">Vendor Payouts</a>
                <a href="#" class="nav-link" onclick="adminLogout()">Logout</a>
            </nav>
        </aside>
        
        <main class="admin-content">
            <div class="content-header">
                <h1>Vendor Management</h1>
                <button class="btn-primary" onclick="openAddVendorPanel()">Add New Vendor</button>
            </div>
            
            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Vendor Name</th>
                            <th>Business Name</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vendors-table-body">
                        
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    
    <div class="edit-panel" id="vendor-panel">
        <div class="edit-panel-header">
            <h2 id="vendor-panel-title">Add New Vendor</h2>
            <button class="close-panel" onclick="closeVendorPanel()">&times;</button>
        </div>
        <div class="edit-panel-content">
            <form id="vendor-form" onsubmit="saveVendor(event)">
                <input type="hidden" id="vendor-id">
                
                <div class="form-group">
                    <label>Vendor Name *</label>
                    <input type="text" id="vendor-name" required>
                    <small>Supplier/Vendor contact name</small>
                </div>
                
                <div class="form-group">
                    <label>Business Name *</label>
                    <input type="text" id="business-name" required>
                    <small>Company or business name</small>
                </div>
                
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="vendor-phone" pattern="[0-9]{10}">
                    <small>10 digit phone number (optional)</small>
                </div>
                
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="vendor-address" rows="3"></textarea>
                    <small>Business address (optional)</small>
                </div>
                
                <div class="form-group">
                    <label>Status *</label>
                    <select id="vendor-status" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                
                <div class="form-message" id="vendor-form-message"></div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save Vendor</button>
                    <button type="button" class="btn-secondary" onclick="closeVendorPanel()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="config.js"></script>
    <script src="supabase-auth.js"></script>
    <script>
        let editingVendorId = null;
        let vendorChannel = null;

        document.addEventListener('DOMContentLoaded', async () => {
            let retries = 0;
            while (typeof window.supabase === 'undefined' && retries < 20) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }
            
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase failed to initialize!');
                showToast('Database connection failed. Please refresh the page.', 'error');
                return;
            }
            
            await loadVendors();
            setupRealtimeSubscription();
        });

        function setupRealtimeSubscription() {
            vendorChannel = window.supabase
                .channel('vendors-channel')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'vendors' },
                    (payload) => {
                        console.log('Vendor change detected:', payload);
                        loadVendors();
                    }
                )
                .subscribe();
            
            console.log('Realtime subscription active for vendors');
        }

        async function loadVendors() {
            const tbody = document.getElementById('vendors-table-body');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading vendors...</td></tr>';
            
            try {
                const { data: vendors, error } = await window.supabase
                    .from('vendors')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading vendors:', error);
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #d32f2f;">Error loading vendors</td></tr>';
                    return;
                }
                
                displayVendors(vendors || []);
            } catch (error) {
                console.error('Error loading vendors:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #d32f2f;">Error loading vendors</td></tr>';
            }
        }

        function displayVendors(vendors) {
            const tbody = document.getElementById('vendors-table-body');
            
            if (vendors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No vendors found. Add your first vendor!</td></tr>';
                return;
            }

            tbody.innerHTML = vendors.map(vendor => {
                const vendorId = String(vendor.id).substring(0, 8) + '...';
                return `
                <tr>
                    <td>${vendorId}</td>
                    <td>${vendor.vendor_name}</td>
                    <td>${vendor.business_name}</td>
                    <td>${vendor.phone || 'N/A'}</td>
                    <td>${vendor.address ? (vendor.address.length > 50 ? vendor.address.substring(0, 50) + '...' : vendor.address) : 'N/A'}</td>
                    <td><span class="status-badge status-${vendor.status || 'active'}">${vendor.status || 'active'}</span></td>
                    <td>
                        <button class="btn-edit" onclick="editVendor('${vendor.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteVendor('${vendor.id}')">Delete</button>
                    </td>
                </tr>
            `}).join('');
        }

        function openAddVendorPanel() {
            editingVendorId = null;
            document.getElementById('vendor-panel-title').textContent = 'Add New Vendor';
            document.getElementById('vendor-form').reset();
            document.getElementById('vendor-id').value = '';
            document.getElementById('vendor-status').value = 'active';
            document.getElementById('vendor-panel').classList.add('active');
        }

        function closeVendorPanel() {
            document.getElementById('vendor-panel').classList.remove('active');
            document.getElementById('vendor-form').reset();
            document.getElementById('vendor-form-message').textContent = '';
            editingVendorId = null;
        }

        async function editVendor(id) {
            try {
                const { data: vendor, error } = await window.supabase
                    .from('vendors')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error || !vendor) {
                    showToast('Error loading vendor details', 'error');
                    return;
                }

                editingVendorId = id;
                document.getElementById('vendor-panel-title').textContent = 'Edit Vendor';
                document.getElementById('vendor-id').value = vendor.id;
                document.getElementById('vendor-name').value = vendor.vendor_name;
                document.getElementById('business-name').value = vendor.business_name;
                document.getElementById('vendor-phone').value = vendor.phone || '';
                document.getElementById('vendor-address').value = vendor.address || '';
                document.getElementById('vendor-status').value = vendor.status || 'active';
                document.getElementById('vendor-panel').classList.add('active');
            } catch (error) {
                console.error('Error loading vendor:', error);
                showToast('Error loading vendor details', 'error');
            }
        }

        async function saveVendor(event) {
            event.preventDefault();

            const vendorName = document.getElementById('vendor-name').value.trim();
            const businessName = document.getElementById('business-name').value.trim();
            const phone = document.getElementById('vendor-phone').value.trim();
            const address = document.getElementById('vendor-address').value.trim();
            const status = document.getElementById('vendor-status').value;
            const messageEl = document.getElementById('vendor-form-message');

            messageEl.textContent = editingVendorId ? 'Updating vendor...' : 'Adding vendor...';
            messageEl.className = 'form-message';

            try {
                if (editingVendorId) {
                    const { error } = await window.supabase
                        .from('vendors')
                        .update({
                            vendor_name: vendorName,
                            business_name: businessName,
                            phone: phone || null,
                            address: address || null,
                            status: status
                        })
                        .eq('id', editingVendorId);
                    
                    if (error) {
                        console.error('Error updating vendor:', error);
                        messageEl.textContent = 'Error updating vendor: ' + error.message;
                        messageEl.className = 'form-message error';
                        return;
                    }
                    
                    messageEl.textContent = 'Vendor updated successfully!';
                } else {
                    const { data, error } = await window.supabase
                        .from('vendors')
                        .insert([{
                            vendor_name: vendorName,
                            business_name: businessName,
                            phone: phone || null,
                            address: address || null,
                            status: status
                        }])
                        .select();
                    
                    if (error) {
                        console.error('Error adding vendor:', error);
                        messageEl.textContent = 'Error adding vendor: ' + error.message;
                        messageEl.className = 'form-message error';
                        return;
                    }
                    
                    console.log('Vendor added with ID:', data[0].id);
                    messageEl.textContent = 'Vendor added successfully!';
                }
                
                messageEl.className = 'form-message success';

                setTimeout(async () => {
                    await loadVendors();
                    closeVendorPanel();
                }, 1000);
            } catch (error) {
                console.error('Error saving vendor:', error);
                messageEl.textContent = 'Error saving vendor. Please try again.';
                messageEl.className = 'form-message error';
            }
        }

        async function deleteVendor(id) {
            if (!confirm('Are you sure you want to delete this vendor? This action cannot be undone.')) {
                return;
            }

            try {
                const { error } = await window.supabase
                    .from('vendors')
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    console.error('Error deleting vendor:', error);
                    if (error.code === '23503') {
                        showToast('Cannot delete vendor. This vendor has products assigned. Please delete or reassign the products first.', 'error');
                    } else {
                        showToast('Error deleting vendor: ' + error.message, 'error');
                    }
                    return;
                }
                
                console.log('Vendor deleted successfully');
                await loadVendors();
            } catch (error) {
                console.error('Error deleting vendor:', error);
                showToast('Error deleting vendor. Please try again.', 'error');
            }
        }

        async function adminLogout() {
            const confirmLogout = confirm('Are you sure you want to logout?');
            if (confirmLogout) {
                try {
                    const { error } = await window.supabase.auth.signOut();
                    if (error) throw error;
                    
                    localStorage.clear();
                    
                    window.location.replace('./index.html');
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Failed to logout. Please try again.', 'error');
                }
            }
        }
    </script>
    <script src="js/toast.js"></script>
</body>
</html>
